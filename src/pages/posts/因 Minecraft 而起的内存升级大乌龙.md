---
layout: ../../layouts/MarkdownPostLayout.astro
title: "因 Minecraft 而起的内存升级大乌龙"
tags: ["日常"]
pubDate: 2023-02-14 21:09:51
weight: 1 # 文章权重，用于同日期文章排序，数字越大排序越靠前
slug: "The-Great-Memory-Upgrade-Fiasco-Caused-by-Minecraft" # 请在此处填写英文 slug，如: my-article-name
---

我电脑的内存本来是 16 G的，本来是对于正常需求，应该是足足够用的。

最近在 Minecraft 中因为实装完成佛冷大佬的[72k刷冰机](https://www.bilibili.com/video/BV1Qd4y1D7xn)后，按理说mspt增长不应该超过 20 那么多，也不会很波动，但我的存档中出现了这个情况。

具体情况为：只要开机以后，机器会正常运行一小时，期间伴随游戏帧率降至 20 - 30 帧，在一小时以后，游戏彻底变得极其卡顿，

这时即使我能移动到开关处将刷冰机关闭，内存占用也会反复顶到最高值，在最高值处游戏卡死，随后降至低值重新增加到最高值卡死，循环往复。

这个时候的解决办法只有一个，直接结束游戏进程，然后会因为结束游戏导致刷冰机没关机直接卸载导致直接损坏，不得已只能回档，有时游戏不是我手动结束进程而是自然崩溃时 PCL 会提醒我游戏因内存分配不足而崩溃，我期间在我存档的镜像存档中测试建造空置域运行刷冰机，即使分配内存给了 10 G，依旧会产生此问题，按理说这台机器的 mspt 不会太高，单机运行应该是完全可以的。

于是我怀疑是电脑的内存不够了，当晚便下单了两条 16 G内存组了双通道，电脑也由 16 G内存升级至 32 G内存，这次我直接分配给 Minecraft 25G 内存，虽然卡顿现象略有改善，但结果还是不变的，依旧是卡死。

在经过两天以后的研究，终于发现了病因所在，即 Minecraft 的光照机制。

在以前的版本中（大概是 1.14 还是 1.15 之前）光照计算是跟游戏进程一起计算的，在这之后的版本，光照计算和游戏进程分为了两个进程计算，这样的话，在大多数情况下，光照计算不会造成游戏卡顿，但缺点是光照计算和游戏进程不同步。

刷冰机就出现了这个问题，在大面积方块更新的情况下产生了大量的光照计算，后来下载了 TIS-carpet-addition 查看光照计算量，开启光照计算 log 后，仅仅开机一分钟，光照计算便达到了 60 万之多，使得Minecraft根本计算不过来，上一秒的光照计算还没算完，下一秒的光照量又来了，于是产生了很严重的卡顿崩溃现象。

最后在网络上找到了办法使光照计算与主线程同步，并限制光照引擎最大任务组数，然后问题得到了彻底解决，这时即使给Minecraft分配 6 G内存也不会卡顿了，好耶！

